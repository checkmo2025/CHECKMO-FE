name: FE Deploy to EC2

on:
  push:
    branches: [dev] # ë°°í¬ ë¸Œëœì¹˜
  workflow_dispatch:

concurrency:
  group: fe-deploy
  cancel-in-progress: true

env:
  REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        # LFS / submodules ì“°ë©´ with: ì˜µì…˜ ì¶”ê°€
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps (clean)
        run: npm ci

      - name: Create .env from secrets
        run: |
          : > .env
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env
          echo "VITE_OAUTH_URL=${{ secrets.VITE_OAUTH_URL }}" >> .env
        shell: bash

      - name: Build
        run: npm run build

      - name: Prepare SSH key & known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p "${SSH_PORT}" "${SSH_HOST}" >> ~/.ssh/known_hosts

      # distë¥¼ ì„ì‹œ ë””ë ‰í„°ë¦¬ë¡œ ì—…ë¡œë“œ
      - name: Upload dist to remote /tmp
        run: |
          TS=$(date +%s)
          echo "TS=$TS" >> $GITHUB_ENV
          rsync -az --delete -e "ssh -i ~/.ssh/deploy_key -p ${SSH_PORT}" \
            dist/ "${SSH_USER}@${SSH_HOST}:/tmp/checkmo-fe_${TS}/"

      # ì›ìì  ìŠ¤ìœ„ì¹˜: releases/<sha or ts> ë¡œ ì´ë™ í›„ ì‹¬ë³¼ë¦­ ë§í¬ êµì²´
      - name: Activate new release & reload nginx
        run: |
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" bash -lc '
            set -e
            RELEASES_DIR="${REMOTE_PATH}/releases"
            CURRENT_LINK="${REMOTE_PATH}/dist"
            NEW_REL="release_${{ github.sha }}"
            # ë””ë ‰í„°ë¦¬ ë³´ì¥
            sudo mkdir -p "$RELEASES_DIR"
            sudo chown -R $USER:$USER "$RELEASES_DIR"
            # /tmpì—ì„œ ë¦´ë¦¬ìŠ¤ë¡œ ì´ë™(ì´ë¦„ì€ ì»¤ë°‹ SHA ê¸°ë°˜)
            sudo rm -rf "$RELEASES_DIR/$NEW_REL"
            sudo mv "/tmp/checkmo-fe_${TS}" "$RELEASES_DIR/$NEW_REL"
            # ì‹¬ë³¼ë¦­ ë§í¬ ìŠ¤ìœ„ì¹˜ (ì›ìì )
            sudo ln -sfn "$RELEASES_DIR/$NEW_REL" "$CURRENT_LINK"
            # nginx ì ê²€ í›„ ë¦¬ë¡œë“œ
            sudo nginx -t
            sudo systemctl reload nginx
          '

      - name: Done
        run: echo "ğŸš€ Deployed to ${SSH_HOST} => ${REMOTE_PATH}"
