name: FE Deploy to EC2

on:
  push:
    branches: [dev] # ë°°í¬ ë¸Œëœì¹˜
  workflow_dispatch:

concurrency:
  group: fe-deploy
  cancel-in-progress: true

env:
  REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install deps (clean)
        run: npm ci

      - name: Create .env from secrets
        shell: bash
        run: |
          : > .env
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env
          echo "VITE_OAUTH_URL=${{ secrets.VITE_OAUTH_URL }}" >> .env

      - name: Build
        run: npm run build

      - name: Prepare SSH key & known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p "${SSH_PORT}" "${SSH_HOST}" >> ~/.ssh/known_hosts

      # ë¦´ë¦¬ìŠ¤ ì´ë¦„ì„ í•œ ë²ˆë§Œ ë§Œë“¤ê³  ì´í›„ ë‹¨ê³„ì—ì„œ ë™ì¼í•˜ê²Œ ì‚¬ìš©
      - name: Set release name
        shell: bash
        run: |
          RELEASE_NAME="release_${{ github.sha }}_${{ github.run_number }}"
          echo "RELEASE_NAME=$RELEASE_NAME" >> "$GITHUB_ENV"

      # distë¥¼ ì„ì‹œ ë””ë ‰í„°ë¦¬ë¡œ ì—…ë¡œë“œ
      - name: Upload dist to remote /tmp
        shell: bash
        run: |
          rsync -az --delete -e "ssh -i ~/.ssh/deploy_key -p ${SSH_PORT}" \
            dist/ "${SSH_USER}@${SSH_HOST}:/tmp/${RELEASE_NAME}/"

      # ì›ìì  ìŠ¤ìœ„ì¹˜: releases/<RELEASE_NAME> ë¡œ ì´ë™ í›„ ì‹¬ë³¼ë¦­ ë§í¬ êµì²´
      - name: Activate new release & reload nginx
        shell: bash
        run: |
          ssh -i ~/.ssh/deploy_key -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" bash -lc "
            set -e
            RELEASES_DIR='${REMOTE_PATH}/releases'
            CURRENT_LINK='${REMOTE_PATH}/dist'
            NEW_REL='${RELEASE_NAME}'

            # ë””ë ‰í„°ë¦¬ ë³´ì¥
            sudo mkdir -p \"\$RELEASES_DIR\"
            # /tmpì—ì„œ ë¦´ë¦¬ìŠ¤ë¡œ ì´ë™
            sudo rm -rf \"\$RELEASES_DIR/\$NEW_REL\"
            sudo mv \"/tmp/\$NEW_REL\" \"\$RELEASES_DIR/\$NEW_REL\"

            # ì‹¬ë³¼ë¦­ ë§í¬ ìŠ¤ìœ„ì¹˜ (ì›ìì )
            sudo ln -sfn \"\$RELEASES_DIR/\$NEW_REL\" \"\$CURRENT_LINK\"

            # nginx ì ê²€ í›„ ë¦¬ë¡œë“œ
            sudo nginx -t
            sudo systemctl reload nginx
          "

      - name: Done
        run: echo "ğŸš€ Deployed ${RELEASE_NAME} to ${SSH_HOST} => ${REMOTE_PATH}"
